"""
å¼‚æ­¥ä¸šåŠ¡å¤„ç† Textual UI æ¼”ç¤º

è¿™ä¸ªåº”ç”¨å±•ç¤ºäº†å¦‚ä½•åœ¨ Textual UI ä¸­å¤„ç†é•¿æ—¶é—´è¿è¡Œçš„ä¸šåŠ¡é€»è¾‘ï¼š
- ä½¿ç”¨ TextArea æ˜¾ç¤ºå®æ—¶æ—¥å¿—
- é€šè¿‡å›è°ƒå‡½æ•°æ›´æ–° UI
- æ”¯æŒå¼€å§‹/åœæ­¢ä¸šåŠ¡å¤„ç†
- æ¨¡æ‹Ÿ IO å¯†é›†å‹æ“ä½œ
"""

import asyncio
import time
from datetime import datetime
from typing import Callable, Optional
from textual.app import App, ComposeResult
from textual.containers import Container, Horizontal, Vertical
from textual.widgets import Header, Footer, Button, TextArea, Static, ProgressBar
from textual.worker import Worker, get_current_worker
from textual import log
import random

class BusinessProcessor:
    """
    ä¸šåŠ¡å¤„ç†ç±»
    
    æ¨¡æ‹Ÿä¸€ä¸ªéœ€è¦é•¿æ—¶é—´è¿è¡Œçš„ä¸šåŠ¡å¤„ç†å™¨ï¼ŒåŒ…å«ï¼š
    - IO å¯†é›†å‹æ“ä½œï¼ˆä½¿ç”¨ sleep æ¨¡æ‹Ÿï¼‰
    - å›è°ƒæœºåˆ¶æ¥æ›´æ–° UI
    - å¯ä¸­æ–­çš„å¤„ç†æµç¨‹
    """
    
    def __init__(self):
        self.is_running = False
        self.log_callback: Optional[Callable[[str], None]] = None
        self.progress_callback: Optional[Callable[[int], None]] = None
        self.total_tasks = 10
        self.current_task = 0
    
    def set_log_callback(self, callback: Callable[[str], None]) -> None:
        """
        è®¾ç½®æ—¥å¿—å›è°ƒå‡½æ•°
        
        Args:
            callback: æ¥æ”¶æ—¥å¿—æ¶ˆæ¯çš„å›è°ƒå‡½æ•°
        """
        self.log_callback = callback
    
    def set_progress_callback(self, callback: Callable[[int], None]) -> None:
        """
        è®¾ç½®è¿›åº¦å›è°ƒå‡½æ•°
        
        Args:
            callback: æ¥æ”¶è¿›åº¦ç™¾åˆ†æ¯”çš„å›è°ƒå‡½æ•°
        """
        self.progress_callback = callback
    
    def _log(self, message: str) -> None:
        """
        å†…éƒ¨æ—¥å¿—æ–¹æ³•ï¼Œé€šè¿‡å›è°ƒå‡½æ•°å‘é€æ—¥å¿—åˆ° UI
        
        Args:
            message: æ—¥å¿—æ¶ˆæ¯
        """
        timestamp = datetime.now().strftime("%H:%M:%S.%f")[:-3]
        full_message = f"[{timestamp}] {message}"
        
        if self.log_callback:
            self.log_callback(full_message)
    
    def _update_progress(self, current: int) -> None:
        """
        æ›´æ–°å¤„ç†è¿›åº¦
        
        Args:
            current: å½“å‰å®Œæˆçš„ä»»åŠ¡æ•°
        """
        progress = int((current / self.total_tasks) * 100)
        if self.progress_callback:
            self.progress_callback(progress)
    
    async def start_processing(self) -> None:
        """
        å¼€å§‹ä¸šåŠ¡å¤„ç†æµç¨‹
        
        è¿™æ˜¯ä¸»è¦çš„ä¸šåŠ¡å‡½æ•°ï¼Œæ¨¡æ‹Ÿä¸€ç³»åˆ—éœ€è¦æ—¶é—´çš„æ“ä½œï¼š
        1. æ•°æ®é¢„å¤„ç†
        2. æ‰¹é‡ä»»åŠ¡å¤„ç†
        3. ç»“æœæ±‡æ€»
        
        ä½¿ç”¨ asyncio.sleep æ¨¡æ‹Ÿ IO æ“ä½œï¼Œä¿æŒ UI å“åº”æ€§
        """
        if self.is_running:
            self._log("âŒ ä¸šåŠ¡å¤„ç†å·²åœ¨è¿è¡Œä¸­ï¼Œè¯·å…ˆåœæ­¢å½“å‰ä»»åŠ¡")
            return
        
        try:
            self.is_running = True
            self.current_task = 0
            
            self._log("ğŸš€ å¼€å§‹ä¸šåŠ¡å¤„ç†æµç¨‹")
            
            # é˜¶æ®µ 1: åˆå§‹åŒ–å’Œé¢„å¤„ç†
            self._log("ğŸ“‹ é˜¶æ®µ 1: æ•°æ®é¢„å¤„ç†...")
            await asyncio.sleep(1.5)  # æ¨¡æ‹Ÿæ•°æ®åŠ è½½æ—¶é—´
            
            if not self.is_running:
                self._log("â¸ï¸  ä¸šåŠ¡å¤„ç†è¢«ç”¨æˆ·ä¸­æ–­")
                return
            
            self._log("âœ… æ•°æ®é¢„å¤„ç†å®Œæˆ")
            
            # é˜¶æ®µ 2: æ‰¹é‡ä»»åŠ¡å¤„ç†
            self._log(f"âš™ï¸  é˜¶æ®µ 2: å¼€å§‹å¤„ç† {self.total_tasks} ä¸ªä»»åŠ¡...")
            
            for i in range(self.total_tasks):
                if not self.is_running:
                    self._log("â¸ï¸  ä¸šåŠ¡å¤„ç†è¢«ç”¨æˆ·ä¸­æ–­")
                    return
                
                # æ¨¡æ‹Ÿæ¯ä¸ªä»»åŠ¡çš„å¤„ç†æ—¶é—´ï¼ˆéšæœº 0.5-2 ç§’ï¼‰
                task_duration = random.uniform(0.5, 2.0)
                task_name = f"ä»»åŠ¡-{i+1:02d}"
                
                self._log(f"ğŸ”„ æ­£åœ¨å¤„ç† {task_name} (é¢„è®¡è€—æ—¶: {task_duration:.1f}s)")
                
                # æ¨¡æ‹Ÿ IO å¯†é›†å‹æ“ä½œ
                await asyncio.sleep(task_duration)
                
                # æ¨¡æ‹Ÿå¶å‘çš„é”™è¯¯æƒ…å†µ
                if random.random() < 0.1:  # 10% æ¦‚ç‡å‡ºç°è­¦å‘Š
                    self._log(f"âš ï¸  {task_name} å¤„ç†æ—¶å‡ºç°è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ")
                else:
                    self._log(f"âœ… {task_name} å¤„ç†å®Œæˆ")
                
                self.current_task = i + 1
                self._update_progress(self.current_task)
                
                # ç»™ UI æ›´æ–°çš„æœºä¼š
                await asyncio.sleep(0.1)
            
            if not self.is_running:
                self._log("â¸ï¸  ä¸šåŠ¡å¤„ç†è¢«ç”¨æˆ·ä¸­æ–­")
                return
            
            # é˜¶æ®µ 3: ç»“æœæ±‡æ€»
            self._log("ğŸ“Š é˜¶æ®µ 3: ç»“æœæ±‡æ€»ä¸­...")
            await asyncio.sleep(1.0)  # æ¨¡æ‹Ÿæ±‡æ€»æ—¶é—´
            
            if not self.is_running:
                self._log("â¸ï¸  ä¸šåŠ¡å¤„ç†è¢«ç”¨æˆ·ä¸­æ–­")
                return
            
            # ç”Ÿæˆå¤„ç†æŠ¥å‘Š
            success_rate = random.uniform(85, 98)
            total_time = sum(random.uniform(0.5, 2.0) for _ in range(self.total_tasks)) + 3.5
            
            self._log("=" * 50)
            self._log("ğŸ“‹ ä¸šåŠ¡å¤„ç†å®ŒæˆæŠ¥å‘Š:")
            self._log(f"   â€¢ æ€»ä»»åŠ¡æ•°: {self.total_tasks}")
            self._log(f"   â€¢ æˆåŠŸç‡: {success_rate:.1f}%")
            self._log(f"   â€¢ æ€»è€—æ—¶: {total_time:.1f} ç§’")
            self._log(f"   â€¢ å¹³å‡æ¯ä»»åŠ¡è€—æ—¶: {total_time/self.total_tasks:.2f} ç§’")
            self._log("=" * 50)
            self._log("ğŸ‰ æ‰€æœ‰ä¸šåŠ¡å¤„ç†å·²æˆåŠŸå®Œæˆï¼")
            
        except asyncio.CancelledError:
            self._log("âŒ ä¸šåŠ¡å¤„ç†è¢«å¼ºåˆ¶å–æ¶ˆ")
        except Exception as e:
            self._log(f"ğŸ’¥ ä¸šåŠ¡å¤„ç†å‘ç”Ÿå¼‚å¸¸: {str(e)}")
        finally:
            self.is_running = False
            self._update_progress(0)  # é‡ç½®è¿›åº¦æ¡
    
    def stop_processing(self) -> None:
        """
        åœæ­¢ä¸šåŠ¡å¤„ç†
        
        è®¾ç½®åœæ­¢æ ‡å¿—ï¼Œä¸šåŠ¡å¾ªç¯ä¼šæ£€æŸ¥æ­¤æ ‡å¿—å¹¶ä¼˜é›…é€€å‡º
        """
        if self.is_running:
            self._log("ğŸ›‘ æ”¶åˆ°åœæ­¢ä¿¡å·ï¼Œæ­£åœ¨ä¼˜é›…é€€å‡º...")
            self.is_running = False
        else:
            self._log("â„¹ï¸  å½“å‰æ²¡æœ‰è¿è¡Œä¸­çš„ä¸šåŠ¡å¤„ç†")

class AsyncBusinessApp(App):
    """
    å¼‚æ­¥ä¸šåŠ¡å¤„ç† Textual åº”ç”¨
    
    è¿™ä¸ªåº”ç”¨å±•ç¤ºäº†å¦‚ä½•åœ¨ Textual ä¸­å¤„ç†é•¿æ—¶é—´è¿è¡Œçš„å¼‚æ­¥ä»»åŠ¡ï¼š
    - å®æ—¶æ—¥å¿—æ˜¾ç¤º
    - è¿›åº¦æ¡æ›´æ–°
    - å¼€å§‹/åœæ­¢æ§åˆ¶
    - éé˜»å¡ UI äº¤äº’
    """
    
    CSS = """
    .main-container {
        height: 100%;
        margin: 1;
    }
    
    .log-container {
        border: solid $accent;
        padding: 1;
        margin-bottom: 1;
        height: 50%;
        
    }
    
    .controls-container {
        border: solid $primary;
        padding: 1;
        height: 50%;
    }
    
    .progress-container {
        margin: 1 0;
    }
    
    .status-text {
        text-align: center;
        margin: 1 0;
    }
    
    .button-group {
        height: auto;
        align: center middle;
    }
    
    #log-area {
        height: 60%;
        min-height: 12;
        background: $surface;
    }
    
    #start-button {
        margin: 0 1;
        min-width: 12;
    }
    
    #stop-button {
        margin: 0 1;
        min-width: 12;
    }
    
    #progress-bar {
        margin: 1 0;
    }
    """
    
    def __init__(self):
        super().__init__()
        self.business_processor = BusinessProcessor()
        self.current_worker: Optional[Worker] = None
        
        # è®¾ç½®ä¸šåŠ¡å¤„ç†å™¨çš„å›è°ƒå‡½æ•°
        self.business_processor.set_log_callback(self.add_log)
        self.business_processor.set_progress_callback(self.update_progress)
    
    def compose(self) -> ComposeResult:
        """æ„å»ºç”¨æˆ·ç•Œé¢"""
        
        yield Header(show_clock=True)
        
        with Container(classes="main-container"):
            # æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ - å ç”¨æ›´å¤§ç©ºé—´
            with Container(classes="log-container"):
                yield Static("ğŸ“‹ ä¸šåŠ¡å¤„ç†æ—¥å¿—", classes="status-text")
                yield TextArea(
                    "=== ä¸šåŠ¡å¤„ç†ç³»ç»Ÿå°±ç»ª ===\n"
                    "ç‚¹å‡»\"å¼€å§‹å¤„ç†\"æŒ‰é’®å¼€å§‹ä¸šåŠ¡æµç¨‹\n"
                    "æ—¥å¿—å°†åœ¨æ­¤å¤„å®æ—¶æ˜¾ç¤º...\n"
                    "\n"
                    "ğŸ’¡ æç¤ºä¿¡æ¯:\n"
                    "- ä¸šåŠ¡å¤„ç†ä¼šæ¨¡æ‹ŸçœŸå®çš„IOæ“ä½œ\n"
                    "- æ¯ä¸ªä»»åŠ¡éœ€è¦0.5-2ç§’çš„å¤„ç†æ—¶é—´\n"
                    "- æ€»å…±éœ€è¦å¤„ç†10ä¸ªä»»åŠ¡\n"
                    "- å¯ä»¥éšæ—¶åœæ­¢æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡\n"
                    "- ç•Œé¢ä¼šä¿æŒå“åº”ï¼Œä¸ä¼šå¡é¡¿\n"
                    "\n"
                    "å‡†å¤‡å¼€å§‹å¤„ç†...",
                    read_only=True,
                    show_line_numbers=True,
                    id="log-area"
                )
            
            # æ§åˆ¶é¢æ¿ - å ç”¨è¾ƒå°ç©ºé—´
            with Container(classes="controls-container"):
                yield Static("ğŸ® æ§åˆ¶é¢æ¿", classes="status-text")
                
                # è¿›åº¦æ¡å®¹å™¨
                with Container(classes="progress-container"):
                    yield Static("å¤„ç†è¿›åº¦:", id="progress-label")
                    yield ProgressBar(total=100, show_eta=False, id="progress-bar")
                
                # æŒ‰é’®ç»„
                with Horizontal(classes="button-group"):
                    yield Button(
                        "ğŸš€ å¼€å§‹å¤„ç†",
                        variant="success",
                        id="start-button"
                    )
                    yield Button(
                        "ğŸ›‘ åœæ­¢å¤„ç†", 
                        variant="error",
                        id="stop-button"
                    )
                    yield Button(
                        "ğŸ—‘ï¸  æ¸…ç©ºæ—¥å¿—",
                        variant="warning", 
                        id="clear-button"
                    )
        
        yield Footer()
    
    def on_mount(self) -> None:
        """åº”ç”¨å¯åŠ¨æ—¶çš„åˆå§‹åŒ–"""
        self.add_log("ğŸ”§ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ")
        self.add_log("ğŸ’¡ æç¤º: ä¸šåŠ¡å¤„ç†æ¨¡æ‹Ÿäº†IOå¯†é›†å‹æ“ä½œï¼Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´")
        self.add_log("âš¡ ç•Œé¢åœ¨å¤„ç†æœŸé—´ä¿æŒå“åº”ï¼Œæ‚¨å¯ä»¥éšæ—¶åœæ­¢å¤„ç†")
        self.add_log("ğŸ“Š TextArea å·²è°ƒæ•´ä¸ºæ›´å¤§å°ºå¯¸ï¼Œå¯æ˜¾ç¤ºæ›´å¤šæ—¥å¿—è¡Œ")
        
        # è®¾ç½®åˆå§‹æŒ‰é’®çŠ¶æ€
        self.update_button_states(False)
    
    def add_log(self, message: str) -> None:
        """
        æ·»åŠ æ—¥å¿—åˆ° TextArea
        
        è¿™ä¸ªæ–¹æ³•è¢«ä¸šåŠ¡å¤„ç†å™¨å›è°ƒè°ƒç”¨ï¼Œå®ç°æ—¥å¿—çš„å®æ—¶æ›´æ–°
        
        Args:
            message: è¦æ·»åŠ çš„æ—¥å¿—æ¶ˆæ¯
        """
        try:
            log_area = self.query_one("#log-area", TextArea)
            
            # åœ¨æœ«å°¾æ·»åŠ æ–°æ—¥å¿—
            current_text = log_area.text
            new_text = current_text + message + "\n"
            log_area.load_text(new_text)
            
            # è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿èƒ½çœ‹åˆ°æœ€æ–°çš„æ—¥å¿—
            log_area.scroll_end()
            
        except Exception as e:
            # å¦‚æœ UI æ›´æ–°å¤±è´¥ï¼Œè®°å½•åˆ°åº”ç”¨æ—¥å¿—
            log(f"æ›´æ–°æ—¥å¿— UI å¤±è´¥: {e}")
    
    def update_progress(self, progress: int) -> None:
        """
        æ›´æ–°è¿›åº¦æ¡
        
        Args:
            progress: è¿›åº¦ç™¾åˆ†æ¯” (0-100)
        """
        try:
            progress_bar = self.query_one("#progress-bar", ProgressBar)
            progress_bar.progress = progress
            
            # æ›´æ–°è¿›åº¦æ ‡ç­¾
            progress_label = self.query_one("#progress-label", Static)
            if progress > 0:
                progress_label.update(f"å¤„ç†è¿›åº¦: {progress}%")
            else:
                progress_label.update("å¤„ç†è¿›åº¦:")
                
        except Exception as e:
            log(f"æ›´æ–°è¿›åº¦ UI å¤±è´¥: {e}")
    
    def update_button_states(self, is_running: bool) -> None:
        """
        æ›´æ–°æŒ‰é’®çŠ¶æ€
        
        Args:
            is_running: æ˜¯å¦æ­£åœ¨è¿è¡Œä¸šåŠ¡å¤„ç†
        """
        try:
            start_button = self.query_one("#start-button", Button)
            stop_button = self.query_one("#stop-button", Button)
            
            # è¿è¡Œæ—¶ç¦ç”¨å¼€å§‹æŒ‰é’®ï¼Œå¯ç”¨åœæ­¢æŒ‰é’®
            start_button.disabled = is_running
            stop_button.disabled = not is_running
            
            # æ›´æ–°æŒ‰é’®æ–‡æœ¬å’Œæ ·å¼
            if is_running:
                start_button.label = "â³ å¤„ç†ä¸­..."
                stop_button.label = "ğŸ›‘ åœæ­¢å¤„ç†"
            else:
                start_button.label = "ğŸš€ å¼€å§‹å¤„ç†"
                stop_button.label = "â¸ï¸  å·²åœæ­¢"
                
        except Exception as e:
            log(f"æ›´æ–°æŒ‰é’®çŠ¶æ€å¤±è´¥: {e}")
    
    async def on_button_pressed(self, event: Button.Pressed) -> None:
        """å¤„ç†æŒ‰é’®ç‚¹å‡»äº‹ä»¶"""
        
        button_id = event.button.id
        
        if button_id == "start-button":
            # å¼€å§‹ä¸šåŠ¡å¤„ç†
            if not self.business_processor.is_running:
                self.add_log("ğŸ‘¤ ç”¨æˆ·ç‚¹å‡»å¼€å§‹å¤„ç†æŒ‰é’®")
                self.update_button_states(True)
                
                # ä½¿ç”¨ Textual çš„ Worker åœ¨åå°è¿è¡Œä¸šåŠ¡å¤„ç†
                # Worker ç¡®ä¿é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ä¸ä¼šé˜»å¡ UI
                self.current_worker = self.run_worker(
                    self.business_processor.start_processing(),
                    exclusive=True,  # åŒæ—¶åªèƒ½è¿è¡Œä¸€ä¸ªä¸šåŠ¡å¤„ç†
                    description="ä¸šåŠ¡å¤„ç†"
                )

        elif button_id == "stop-button":
            # åœæ­¢ä¸šåŠ¡å¤„ç†
            if self.business_processor.is_running:
                self.add_log("ğŸ‘¤ ç”¨æˆ·ç‚¹å‡»åœæ­¢å¤„ç†æŒ‰é’®")
                self.business_processor.stop_processing()
                
                # å¦‚æœæœ‰æ´»åŠ¨çš„ Workerï¼Œå°è¯•å–æ¶ˆå®ƒ
                if self.current_worker and not self.current_worker.is_finished:
                    self.current_worker.cancel()
        
        elif button_id == "clear-button":
            # æ¸…ç©ºæ—¥å¿—
            try:
                log_area = self.query_one("#log-area", TextArea)
                log_area.load_text("=== æ—¥å¿—å·²æ¸…ç©º ===\nå‡†å¤‡æ¥æ”¶æ–°çš„æ—¥å¿—ä¿¡æ¯...\n")
                self.add_log("ğŸ‘¤ ç”¨æˆ·æ¸…ç©ºäº†æ—¥å¿—")
            except Exception as e:
                log(f"æ¸…ç©ºæ—¥å¿—å¤±è´¥: {e}")

    def on_worker_state_changed(self, event: Worker.StateChanged) -> None:
        """å½“ Worker çŠ¶æ€æ”¹å˜æ—¶è¢«è°ƒç”¨"""
        if event.worker.is_finished:
            self.add_log("ğŸ”§ ä¸šåŠ¡å¤„ç† Worker å·²ç»“æŸ")
            self.update_button_states(False)
            self.current_worker = None

    def on_unmount(self) -> None:
        """åº”ç”¨å…³é—­æ—¶çš„æ¸…ç†å·¥ä½œ"""
        if self.business_processor.is_running:
            self.business_processor.stop_processing()
        
        if self.current_worker and not self.current_worker.is_finished:
            self.current_worker.cancel()

if __name__ == "__main__":
    """
    åº”ç”¨ç¨‹åºå…¥å£ç‚¹
    
    è¿è¡Œè¿™ä¸ªè„šæœ¬å°†å¯åŠ¨ä¸€ä¸ªå…¨å±çš„ TUI åº”ç”¨ï¼Œå±•ç¤ºï¼š
    - æ›´å¤§çš„å®æ—¶æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸï¼ˆè‡³å°‘èƒ½æ˜¾ç¤º10+è¡Œï¼‰
    - å¼‚æ­¥ä¸šåŠ¡å¤„ç†
    - è¿›åº¦è·Ÿè¸ª
    - ç”¨æˆ·äº¤äº’æ§åˆ¶
    """
    app = AsyncBusinessApp()
    app.run()
